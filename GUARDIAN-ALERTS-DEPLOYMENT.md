# Guardian Agent Alert System - Deployment Guide

## Status: ‚ö†Ô∏è **READY TO DEPLOY**

The Guardian Agent alert system is configured and ready, but the database tables are **not yet deployed**. This guide will help you deploy them in 2 minutes.

---

## What is the Guardian Agent Alert System?

The Guardian Agent is your **automated security monitoring system** that:
- üîç **Detects security vulnerabilities** (XSS, SQL injection, PHI exposure)
- üß† **Generates automatic fixes** for code issues
- üé• **Records sessions** with Guardian Eyes for review
- üìä **Monitors system health** and performance
- üîß **Creates pull requests** with approved fixes

### How It Works

```
[Code Issue Detected] ‚Üí [Guardian Agent Analyzes] ‚Üí [Alert Created]
       ‚Üì                          ‚Üì                          ‚Üì
[Guardian Eyes Records]   [Generate Fix (if possible)]   [Notify Security Panel]
       ‚Üì                          ‚Üì                          ‚Üì
[Store in Database]        [Create Pull Request]       [Email (if critical)]
```

---

## Current Status

| Component | Status | Location |
|-----------|--------|----------|
| **GuardianAlertService.ts** | ‚úÖ Deployed | `src/services/guardian-agent/` |
| **Guardian Cron Jobs** | ‚úÖ Configured | Every 5 min + daily summary |
| **Database Tables** | ‚ùå **NOT DEPLOYED** | Migration ready |
| **RLS Policies** | ‚è≥ In migration | Will deploy with tables |
| **Triggers & Functions** | ‚è≥ In migration | Will deploy with tables |

**Issue:** GuardianAlertService **will fail** when trying to create alerts because `guardian_alerts` table doesn't exist.

---

## Quick Deployment (2 Minutes)

### Option 1: Manual Deployment via SQL Editor (Recommended)

**Why this option?** CLI deployment is currently blocked by other migration conflicts. Manual deployment is clean and quick.

1. **Open Supabase SQL Editor**
   ```
   https://supabase.com/dashboard/project/xkybsjnvuohpqpbkikyn/sql/new
   ```

2. **Copy SQL Script**
   - Open file: [deploy-guardian-alerts.sql](deploy-guardian-alerts.sql)
   - Copy entire contents (Ctrl+A, Ctrl+C)

3. **Paste and Run**
   - Paste into SQL Editor
   - Click green **"Run"** button
   - Wait for execution (~5-10 seconds)

4. **Verify Success**
   Check "Messages" tab for:
   ```
   NOTICE:  ‚úÖ Guardian alerts system deployed successfully!
   NOTICE:  Tables created: guardian_alerts, security_notifications
   NOTICE:  Functions created: get_unread_security_notifications_count, get_pending_alerts_by_severity, auto_dismiss_old_info_alerts
   NOTICE:  Trigger created: trigger_notify_new_guardian_alert
   NOTICE:  Guardian Agent is now operational and can create alerts.
   ```

**Done!** Guardian Agent is now fully operational.

---

## What Gets Deployed

### Tables

#### 1. `guardian_alerts`
Stores all security alerts generated by Guardian Agent.

**Columns:**
- `id` - Alert identifier
- `severity` - info, warning, critical, emergency
- `category` - security_vulnerability, phi_exposure, memory_leak, api_failure, healing_generated, system_health
- `title` - Alert title
- `description` - Detailed description
- `session_recording_id` - Link to Guardian Eyes recording
- `video_timestamp` - When in the video the issue occurred
- `healing_operation_id` - ID of auto-healing operation
- `generated_fix` - JSON with code fix details
- `affected_component` - File path or component name
- `affected_users` - Array of impacted user IDs
- `status` - pending, acknowledged, reviewing, resolved, dismissed
- `acknowledged_by` - Who acknowledged the alert
- `actions` - Array of available actions (view recording, apply fix, etc.)
- `metadata` - Additional data (auto-healable, estimated impact, etc.)

**Indexes:**
- Status (for filtering unresolved alerts)
- Severity (for priority sorting)
- Category (for grouping by type)
- Created date (for time-based queries)
- Session recording ID (for video lookups)

#### 2. `security_notifications`
Persistent inbox for security team notifications.

**Columns:**
- `id` - Notification UUID
- `type` - guardian_alert, compliance_reminder, audit_flag, etc.
- `severity` - Alert severity level
- `title` - Notification title
- `message` - Notification message
- `link` - URL to relevant page
- `read` - Whether notification has been read
- `read_at` - When it was read
- `read_by` - Who read it
- `metadata` - Additional JSON data

**Indexes:**
- Read status (for unread count)
- Created date (for chronological sorting)
- Type (for filtering by notification type)

### Security (RLS Policies)

**Who Can Access:**
- **Security Admins** (`SECURITY_ADMIN` role)
- **Compliance Officers** (`COMPLIANCE_OFFICER` role)
- **System Admins** (`ADMIN` role)

**Permissions:**
- **View all alerts** - Security team only
- **Update alerts** (acknowledge, resolve) - Security team only
- **Insert alerts** - Authenticated users (Guardian Agent)
- **View notifications** - Security team only
- **Mark as read** - Security team only
- **Insert notifications** - Authenticated users (system)

### Helper Functions

#### `get_unread_security_notifications_count()`
Returns count of unread notifications for current user.

**Usage:**
```sql
SELECT get_unread_security_notifications_count();
-- Returns: 5
```

#### `get_pending_alerts_by_severity()`
Returns count of pending/acknowledged alerts grouped by severity.

**Usage:**
```sql
SELECT * FROM get_pending_alerts_by_severity();
-- Returns:
-- severity   | count
-- -----------+-------
-- critical   | 3
-- warning    | 12
-- info       | 5
```

#### `auto_dismiss_old_info_alerts()`
Auto-dismisses info-level alerts older than 7 days (cleanup function).

**Usage:**
```sql
SELECT auto_dismiss_old_info_alerts();
-- Returns: 8 (number of alerts dismissed)
```

**Cron Job:** Run weekly to keep alert table clean.

### Triggers

#### `trigger_notify_new_guardian_alert`
Fires when a new alert is inserted, sending real-time notification via `pg_notify`.

**Channel:** `guardian_alert_created`
**Payload:** JSON with `{id, severity, title, category}`

**Integration:** Used by GuardianAlertService.subscribeToAlerts() for real-time updates.

---

## Testing After Deployment

### 1. Verify Tables Exist

```sql
-- Check tables
SELECT tablename FROM pg_tables
WHERE tablename IN ('guardian_alerts', 'security_notifications');

-- Should return both table names
```

### 2. Test Permissions

```sql
-- Try to select (should work if you're a security admin)
SELECT COUNT(*) FROM guardian_alerts;
SELECT COUNT(*) FROM security_notifications;
```

### 3. Test Helper Functions

```sql
-- Get unread count
SELECT get_unread_security_notifications_count();

-- Get pending alerts by severity
SELECT * FROM get_pending_alerts_by_severity();
```

### 4. Create Test Alert (Optional)

```typescript
import { GuardianAlertService } from './services/guardian-agent/GuardianAlertService';

// Create a test PHI exposure alert
await GuardianAlertService.alertPHIExposure({
  location: 'console_log',
  phi_type: 'ssn',
  component: 'TestComponent',
  session_recording_id: 'test-session-123',
  video_timestamp: 1500,
  user_id: 'test-user-456'
});
```

**Expected Result:** Alert inserted in database, real-time notification sent to Security Panel.

---

## Integration with Existing Systems

### Guardian Cron Jobs (Already Configured)

**File:** `supabase/migrations/20251107180000_guardian_cron_monitoring.sql`

**Jobs:**
1. **Every 5 minutes** - `guardian-automated-monitoring`
   - Calls Guardian Agent monitoring function
   - Checks for security issues
   - Creates alerts if issues found

2. **Daily at 8 AM UTC** - `guardian-daily-summary`
   - Generates daily summary report
   - Analyzes trends
   - Sends summary email (when email integration complete)

**Status:** ‚úÖ Already deployed and running

### Guardian Alert Service (Already Deployed)

**File:** `src/services/guardian-agent/GuardianAlertService.ts`

**Methods:**
- `sendAlert()` - Create new alert
- `alertSecurityVulnerability()` - XSS, SQL injection, PHI exposure
- `alertPHIExposure()` - Critical PHI leaks
- `alertHealingGenerated()` - Auto-generated code fixes
- `alertMemoryLeak()` - Memory leak detection
- `getPendingAlerts()` - Get unresolved alerts
- `acknowledgeAlert()` - Mark alert as seen
- `resolveAlert()` - Mark alert as resolved
- `approveAndCreatePR()` - Approve fix and create pull request

**Status:** ‚úÖ Service deployed, ready to use once tables are deployed

---

## Alert Workflow Examples

### Example 1: PHI Exposure Detection

```
1. Guardian Eyes detects SSN in browser console
2. GuardianAlertService.alertPHIExposure() called
3. Alert inserted into guardian_alerts table
4. Trigger fires: pg_notify('guardian_alert_created', ...)
5. Security Panel receives real-time notification
6. Email sent to security team (critical severity)
7. Security admin opens Guardian Eyes recording at exact timestamp
8. Admin reviews code where PHI was exposed
9. Admin acknowledges alert
10. Developer fixes issue
11. Admin resolves alert with notes
```

### Example 2: Auto-Healing Code Fix

```
1. Guardian Agent detects XSS vulnerability during monitoring
2. Guardian generates fix automatically
3. GuardianAlertService.alertSecurityVulnerability() called
4. Alert stored with generated_fix JSON
5. Security admin reviews fix in Security Panel
6. Admin clicks "Approve & Apply Fix"
7. GuardianAlertService.approveAndCreatePR() creates GitHub PR
8. PR includes code diff, security context, test plan
9. Team reviews and merges PR
10. Alert status updated to 'resolved'
11. Fix deployed
```

### Example 3: Memory Leak Detection

```
1. Guardian monitoring detects memory leak (>500MB usage)
2. Guardian records memory profile
3. GuardianAlertService.alertMemoryLeak() called
4. Alert created with leak type and component
5. Developer opens Guardian Eyes memory profile
6. Developer identifies subscription not cleaned up
7. Developer fixes cleanup in useEffect
8. Developer marks alert as resolved
```

---

## Monitoring & Maintenance

### View Active Alerts

```sql
-- All pending critical alerts
SELECT id, title, affected_component, created_at
FROM guardian_alerts
WHERE status = 'pending' AND severity = 'critical'
ORDER BY created_at DESC;

-- All unacknowledged alerts
SELECT severity, category, title, created_at
FROM guardian_alerts
WHERE status = 'pending' AND acknowledged_by IS NULL
ORDER BY created_at DESC;
```

### View Alert Statistics

```sql
-- Alerts by category (last 30 days)
SELECT category, COUNT(*) as total,
       SUM(CASE WHEN status = 'resolved' THEN 1 ELSE 0 END) as resolved
FROM guardian_alerts
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY category
ORDER BY total DESC;

-- Average resolution time
SELECT
  category,
  AVG(EXTRACT(EPOCH FROM (acknowledged_at - created_at)) / 3600) as avg_hours_to_acknowledge,
  AVG(EXTRACT(EPOCH FROM (acknowledged_at - created_at)) / 3600) as avg_hours_to_resolve
FROM guardian_alerts
WHERE status = 'resolved'
GROUP BY category;
```

### Cleanup Old Alerts

```sql
-- Manual cleanup (or schedule as cron job)
SELECT auto_dismiss_old_info_alerts();

-- Archive resolved alerts older than 90 days (optional)
-- Create archive table first, then:
INSERT INTO guardian_alerts_archive
SELECT * FROM guardian_alerts
WHERE status = 'resolved' AND created_at < NOW() - INTERVAL '90 days';

DELETE FROM guardian_alerts
WHERE status = 'resolved' AND created_at < NOW() - INTERVAL '90 days';
```

---

## Troubleshooting

### Issue: Tables not visible after deployment

**Solution:**
```sql
-- Check if tables exist
SELECT schemaname, tablename
FROM pg_tables
WHERE tablename IN ('guardian_alerts', 'security_notifications');

-- If not found, check for errors in migration
SELECT * FROM guardian_cron_log ORDER BY executed_at DESC LIMIT 10;
```

### Issue: Cannot insert alerts (permission denied)

**Solution:**
```sql
-- Check RLS policies
SELECT * FROM pg_policies WHERE tablename = 'guardian_alerts';

-- Grant permissions if missing
GRANT SELECT, INSERT, UPDATE ON guardian_alerts TO authenticated;
```

### Issue: Real-time notifications not working

**Solution:**
1. Check trigger exists:
   ```sql
   SELECT * FROM pg_trigger WHERE tgname = 'trigger_notify_new_guardian_alert';
   ```

2. Check Supabase Realtime is enabled for table (in Supabase Dashboard)

3. Verify subscription in client code:
   ```typescript
   const unsubscribe = GuardianAlertService.subscribeToAlerts((alert) => {
     console.log('New alert:', alert);
   });
   ```

### Issue: Helper functions returning errors

**Solution:**
```sql
-- Check function exists
SELECT proname FROM pg_proc
WHERE proname LIKE '%guardian%' OR proname LIKE '%security_notification%';

-- Re-grant execute permissions
GRANT EXECUTE ON FUNCTION get_unread_security_notifications_count() TO authenticated;
GRANT EXECUTE ON FUNCTION get_pending_alerts_by_severity() TO authenticated;
GRANT EXECUTE ON FUNCTION auto_dismiss_old_info_alerts() TO authenticated;
```

---

## Next Steps After Deployment

1. ‚úÖ **Deploy tables** (this guide)
2. ‚è≥ **Configure email service** for critical alerts
   - Integrate SendGrid, AWS SES, or MailerSend
   - Update GuardianAlertService.sendEmailNotification()
3. ‚è≥ **Test Guardian monitoring** end-to-end
   - Manually trigger: `SELECT trigger_guardian_monitoring();`
   - Verify alerts appear in Security Panel
4. ‚è≥ **Set up Security Panel UI** (if not done)
   - Create `/security/alerts` page
   - Display guardian_alerts table
   - Add acknowledge/resolve buttons
5. ‚è≥ **Configure GitHub integration**
   - Install GitHub CLI: `gh auth login`
   - Test PR creation with auto-healing fix

---

## Related Files

- **Deployment SQL:** [deploy-guardian-alerts.sql](deploy-guardian-alerts.sql)
- **Migration:** [supabase/migrations/20251112210000_guardian_alerts_system.sql](supabase/migrations/20251112210000_guardian_alerts_system.sql)
- **Service:** [src/services/guardian-agent/GuardianAlertService.ts](src/services/guardian-agent/GuardianAlertService.ts)
- **Cron Jobs:** [supabase/migrations/20251107180000_guardian_cron_monitoring.sql](supabase/migrations/20251107180000_guardian_cron_monitoring.sql)
- **Documentation:** [ALERTS-AND-NOTIFICATIONS-INVENTORY.md](ALERTS-AND-NOTIFICATIONS-INVENTORY.md)

---

## Support

**Questions?**
- Check GuardianAlertService.ts for TypeScript types and examples
- Review ALERTS-AND-NOTIFICATIONS-INVENTORY.md for system overview
- Test queries in Supabase SQL Editor

**Issues?**
- Verify RLS policies are correctly configured
- Check user role is SECURITY_ADMIN, COMPLIANCE_OFFICER, or ADMIN
- Review Supabase logs for error messages
