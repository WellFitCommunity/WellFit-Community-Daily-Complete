# Twilio OTP Implementation Analysis - WellFit Community App

## Executive Summary
The registration flow uses **Twilio Verify Service** for SMS-based OTP (One-Time Password) verification. The implementation is split across Supabase Edge Functions and includes hCaptcha integration. A critical bug has been identified in the auto-signin logic.

---

## 1. WHERE TWILIO SERVICE/API CALLS ARE MADE

### 1.1 Backend Service Layer
**File: `/api/_lib/twilio.ts`** (Vercel API - Basic wrapper)
- Direct REST API calls to `https://api.twilio.com/2010-04-01/Accounts/{ACCOUNT_SID}/Messages.json`
- Uses Basic Auth (base64 encoded Account SID:Auth Token)
- Supports both Messaging Service SID and From Number configurations
- Returns JSON response with `sid` (SMS ID) on success

### 1.2 SMS Sending Endpoints
**File: `/api/sms/send.ts`** (Vercel API endpoint)
- HTTP POST endpoint at `/api/sms/send`
- Requires either valid user session OR internal API key
- Calls `sendSms()` from twilio.ts
- Used for general SMS notifications (non-registration)

**File: `/supabase/functions/send-sms/index.ts`** (Deno edge function)
- HTTP POST endpoint at `{SUPABASE_URL}/functions/v1/send-sms`
- Accepts array of phone numbers for batch sending
- Supports priority levels (normal/high/urgent)
- Includes detailed error handling with per-recipient failure tracking

### 1.3 OTP Generation & Sending (Registration-Specific)
**File: `/supabase/functions/sms-send-code/index.ts`** (Deno edge function) - PRIMARY FOR REGISTRATION
- HTTP POST endpoint at `{SUPABASE_URL}/functions/v1/sms-send-code`
- **Uses Twilio Verify Service API** (not direct SMS)
- Endpoint: `https://verify.twilio.com/v2/Services/{VERIFY_SID}/Verifications`
- OTP codes are generated and managed by Twilio (not custom generation)
- Validates phone number in E.164 format (required)
- Supports both SMS and voice channels

### 1.4 Verification Endpoint
**File: `/supabase/functions/verify-sms-code/index.ts`** (Deno edge function)
- HTTP POST endpoint at `{SUPABASE_URL}/functions/v1/verify-sms-code` (note: named "sms-verify-code" in code)
- Calls Twilio Verify API: `https://verify.twilio.com/v2/Services/{VERIFY_SID}/VerificationCheck`
- Validates OTP code against Twilio's service
- Completes registration and creates user account on success

---

## 2. HOW OTP CODES ARE GENERATED AND SENT

### 2.1 Registration Flow with OTP

```
User Submit Registration Form
    â†“
hCaptcha Verification (frontend)
    â†“
POST /register endpoint
    â†“
    â”œâ”€ Verify hCaptcha token
    â”œâ”€ Validate form data (phone, password, name, email)
    â”œâ”€ Normalize phone to E.164 format
    â”œâ”€ Check if phone already exists (auth.users or pending_registrations)
    â”œâ”€ Store in pending_registrations table (with plaintext password temporarily)
    â””â”€ Call /sms-send-code edge function
         â†“
    POST to Twilio Verify API
    Twilio generates and sends 6-digit OTP via SMS
         â†“
    Response with verification SID
    Update pending_registrations.verification_code_sent = true
         â†“
Navigate to /verify page
    â†“
User enters 6-digit code
    â†“
POST /verify-sms-code endpoint
    â†“
    â”œâ”€ Call Twilio Verify VerificationCheck API
    â”œâ”€ If approved:
    â”‚   â”œâ”€ Create auth user (from pending registration data)
    â”‚   â”œâ”€ Create profile
    â”‚   â”œâ”€ Create FHIR Patient resource
    â”‚   â”œâ”€ Send welcome email
    â”‚   â”œâ”€ Auto sign-in user
    â”‚   â””â”€ Delete pending registration
    â””â”€ Return session token
```

### 2.2 OTP Code Details

**Generation**: 
- Generated by Twilio (not custom logic)
- 6-digit numeric code
- Valid for 10 minutes by default (Twilio standard)
- Only one active verification per phone number at a time

**Delivery**:
- SMS channel (primary)
- Voice call channel (alternative, if supported)
- Sent via Twilio infrastructure (international support)

**Temporary Storage**:
- NOT stored in database
- Twilio maintains verification state internally
- No plaintext OTP in logs (good security practice)

---

## 3. ERROR HANDLING AROUND SMS SENDING

### 3.1 Registration Function Error Handling
**File: `/supabase/functions/register/index.ts` (Lines 318-403)**

```typescript
// SMS sending is wrapped in try-catch, non-fatal
let smsSent = false;
try {
  const smsResponse = await fetch(`${functionsUrl}/sms-send-code`, {...});
  if (smsResponse.ok) {
    // Mark as sent
    smsSent = true;
  } else {
    // Log error but continue registration
    console.error("[register] SMS send failed:", responseText);
  }
} catch (smsError) {
  console.error("[register] SMS send error:", smsError);
}
```

**Key Point**: SMS sending failures are **non-blocking**. Registration continues even if SMS fails.

### 3.2 Audit Logging
Comprehensive HIPAA audit logging for all failure scenarios:
- `USER_REGISTER_FAILED` - Registration rejected (captcha, duplicate phone, DB error)
- `SMS_VERIFICATION_SENT` - SMS sent successfully
- `SMS_VERIFICATION_FAILED` - SMS send failed (non-fatal)
- `SMS_VERIFICATION_ERROR` - SMS exception thrown
- `USER_REGISTER_PENDING` - Registration pending SMS verification

Audit logs include:
- Event type and category
- Actor IP address and User-Agent
- Error code and message
- Phone number (masked)
- Metadata (role, name, etc.)

### 3.3 Verification Error Handling
**File: `/supabase/functions/verify-sms-code/index.ts` (Lines 93-121)**

```typescript
if (!twilioResp.ok) {
  // Map Twilio HTTP status to error codes
  if (twilioResp.status === 401) code = "TWILIO_AUTH_FAILED";
  if (twilioResp.status === 403) code = "TWILIO_FORBIDDEN";
  if (twilioResp.status === 400) code = "TWILIO_BAD_REQUEST";
  if (twilioResp.status === 404) code = "TWILIO_SERVICE_NOT_FOUND";
  
  // Return helpful error messages
  return new Response(JSON.stringify({
    error: code,
    provider_status: twilioResp.status,
    details: txt,
    help: "Check credentials or service configuration"
  }), { status, headers });
}
```

### 3.4 Common Error Scenarios

| Error | Cause | User Impact |
|-------|-------|------------|
| TWILIO_AUTH_FAILED | Invalid Account SID/Auth Token | Registration fails at SMS step |
| TWILIO_SERVICE_NOT_FOUND | Invalid VERIFY_SID | Registration fails, SMS not sent |
| TWILIO_BAD_REQUEST | Phone format invalid | Registration fails, generic error shown |
| INVALID_PHONE | E.164 format violation | Immediate validation error (400) |
| SMS_SEND_FAILED | Twilio API unavailable | Registration continues, SMS may retry |

### 3.5 Error Recovery
- **Resend**: Frontend resend button (45-second cooldown)
- **Duplicate Registration**: If phone already pending, resends OTP
- **Expiration**: Pending registrations auto-expire after 24 hours
- **Manual Retry**: Users can restart registration process

---

## 4. TIMING AND ASYNC ISSUES

### 4.1 Potential Issues Found

#### CRITICAL BUG ðŸ”´
**File: `/supabase/functions/verify-sms-code/index.ts` (Line 204)**

```typescript
// LINE 204 - UNDEFINED VARIABLE!
const { data: sessionData, error: sessionError } = await supabase.auth.signInWithPassword({
  phone: phone,
  password: temporaryPassword,  // âŒ NOT DEFINED - should be 'userPassword'
});
```

**Impact**: Auto-signin after SMS verification will fail with "temporaryPassword is not defined" error

**Expected Fix**:
```typescript
password: userPassword,  // Defined at line 103
```

#### ISSUE: No Timeout on Twilio API Calls
**Files**: `sms-send-code/index.ts` (line 82), `verify-sms-code/index.ts` (line 44)

```typescript
// No fetch timeout specified
const twilioResp = await fetch(url, {
  method: "POST",
  headers: {...},
  body: form.toString(),
  // âŒ Missing: timeout configuration
});
```

**Impact**: 
- Requests could hang indefinitely
- Default browser/Deno timeout (usually 30-60 seconds) applies
- No explicit backoff strategy

**Best Practice**: Add explicit timeout
```typescript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
const twilioResp = await fetch(url, {..., signal: controller.signal});
clearTimeout(timeoutId);
```

### 4.2 Async Flow Timing

```
Registration Submit (synchronous validation)
  â†“ 200ms
hCaptcha Verify (async, 45-sec timeout max)
  â†“
POST /register endpoint
  â†“ ~100ms
hCaptcha verification with hCaptcha.com
  â†“ 
Store in pending_registrations
  â†“
Async: Call /sms-send-code (parallel, non-blocking)
  â”œâ”€ 500-2000ms: Network latency to Twilio
  â”œâ”€ Twilio generates OTP
  â”œâ”€ Twilio sends SMS (async, status unknown)
  â””â”€ Returns immediately with verification SID
  â†“ 
Return success response (with sms_sent flag)
  â†“
Frontend navigates to /verify page
```

**Issue**: SMS delivery status is returned immediately but actual SMS may still be in queue. Users might not receive code for 5-30 seconds in high-load scenarios.

### 4.3 Verification Code Timeout
- **Code validity**: 10 minutes (Twilio default)
- **Pending registration expiry**: 24 hours
- **Resend cooldown**: 45 seconds (frontend enforced)
- **No server-side rate limiting**: Could allow brute force on verification attempts

### 4.4 Race Conditions

#### Registration Race Guard (Good)
**File**: `src/pages/RegisterPage.tsx` (Lines 58-160)
```typescript
// Race guard against duplicate submissions
const submitCounterRef = useRef(0);
const completedRef = useRef(false);

// Only accept captcha token from latest submission
if (mySubmitId !== submitCounterRef.current || completedRef.current) return;
```

#### Verify Page Race Guard (Minimal)
**File**: `src/pages/VerifyCodePage.tsx`
- No explicit race guard for verify submission
- Multiple rapid submissions could cause confusion
- Auto-submit on 6 digits (no guard)

---

## 5. CONFIGURATION (WITHOUT EXPOSING CREDENTIALS)

### 5.1 Required Environment Variables

```bash
# Twilio Credentials (set in Supabase secrets or .env)
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_auth_token_here

# SMS Verification Service (for Verify API)
TWILIO_VERIFY_SERVICE_SID=VAxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# OR
TWILIO_VERIFY_SID=VAxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# SMS Sending Configuration (choose one)
TWILIO_MESSAGING_SERVICE_SERVICE_SID=MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# OR
TWILIO_FROM_NUMBER=+15551234567

# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
SUPABASE_ANON_KEY=eyJhbGc...

# hCaptcha
HCAPTCHA_SECRET=your_hcaptcha_secret_here
```

### 5.2 Twilio Verify Service Setup

Twilio Verify Service provides:
- Automatic OTP generation (6-digit numeric)
- Built-in SMS/voice delivery
- Automatic rate limiting
- Fraud detection
- Delivery tracking
- Customizable message templates

**Verify Service SID Format**: Starts with `VA` (e.g., `VA1234567890abcdef1234567890abcdef`)

### 5.3 Configuration Validation

The code includes robust configuration checks:

```typescript
// sms-send-code/index.ts (lines 33-58)
const getEnv = (...keys: string[]): string => {
  for (const k of keys) {
    const v = Deno.env.get(k);
    if (v && v.trim().length > 0) return v.trim();
  }
  return "";
};

// Returns meaningful error if config missing
if (!TWILIO_ACCOUNT_SID || !TWILIO_AUTH_TOKEN || !VERIFY_SID) {
  return new Response(JSON.stringify({
    error: "SERVER_NOT_CONFIGURED",
    debug: {
      hasSid: Boolean(TWILIO_ACCOUNT_SID),
      hasToken: Boolean(TWILIO_AUTH_TOKEN),
      hasVerify: Boolean(VERIFY_SID),
    }
  }), { status: 500, headers });
}
```

### 5.4 Installation Instructions

1. **Create Twilio Account**
   - Visit https://www.twilio.com/console
   - Create project and get Account SID

2. **Create Verify Service**
   - Go to Messaging â†’ Verify Services
   - Create new service
   - Copy Service SID (format: VA...)

3. **Set Up Edge Function Secrets**
   ```bash
   supabase secrets set TWILIO_ACCOUNT_SID=ACxxxxxxxx
   supabase secrets set TWILIO_AUTH_TOKEN=your_token
   supabase secrets set TWILIO_VERIFY_SERVICE_SID=VAxxxxxxxx
   supabase secrets set HCAPTCHA_SECRET=your_hcaptcha_secret
   ```

4. **Alternative: Messaging Service**
   - Instead of FROM_NUMBER, create Messaging Service in Twilio
   - Get Service SID (format: MG...)
   - Set: `TWILIO_MESSAGING_SERVICE_SID=MGxxxxxxxx`

---

## 6. DATABASE SCHEMA

### 6.1 Pending Registrations Table
**File**: `/supabase/migrations/20250920000000_pending_registrations.sql`
**Updated**: `/supabase/migrations/20251107000000_fix_password_storage.sql`

```sql
CREATE TABLE public.pending_registrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone TEXT NOT NULL UNIQUE,
  password_plaintext TEXT NOT NULL,  -- Temporary, expires 24h, service-role only
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  email TEXT,
  role_code INTEGER NOT NULL DEFAULT 4,
  role_slug TEXT NOT NULL DEFAULT 'senior',
  hcaptcha_verified BOOLEAN DEFAULT true,
  verification_code_sent BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours'),
  tenant_id UUID REFERENCES tenants(id)
);

-- Indexes
CREATE INDEX idx_pending_registrations_phone ON pending_registrations(phone);
CREATE INDEX idx_pending_registrations_expires_at ON pending_registrations(expires_at);
CREATE INDEX idx_pending_registrations_tenant_id ON pending_registrations(tenant_id);

-- RLS Policy: Service role only (no client access)
ALTER TABLE pending_registrations ENABLE ROW LEVEL SECURITY;
GRANT ALL ON pending_registrations TO service_role;
```

**Data Retention**: 24 hours (auto-deleted by scheduled cleanup function)

**Security**: 
- RLS blocks direct client access
- Plaintext password stored temporarily only (never exposed to clients)
- Service role only access

---

## 7. FRONTEND FLOW

### 7.1 Registration Page
**File**: `src/pages/RegisterPage.tsx`

```
Form Validation
  â”œâ”€ First name (required)
  â”œâ”€ Last name (required)
  â”œâ”€ Phone: E.164 format, US numbers only (+1XXXXXXXXXX)
  â”œâ”€ Email: Optional (required for caregivers)
  â”œâ”€ Password: 8+ chars, uppercase, lowercase, number, special char
  â”œâ”€ Confirm password
  â””â”€ Terms agreement

hCaptcha Verification (invisible, auto-triggered on submit)
  â”œâ”€ 45-second timeout
  â”œâ”€ Resilient retry logic
  â””â”€ Race guard for late callbacks

Phone Normalization
  â”œâ”€ Input: "+1 555-555-5555" or "5555555555"
  â””â”€ Output: "+15555555555"

Role Assignment
  â”œâ”€ Client-side advisory only
  â”œâ”€ Server enforces safe public roles (4,5,6,11,13)
  â””â”€ Maps to: senior, volunteer, caregiver, contractor, regular
```

### 7.2 Verification Page
**File**: `src/pages/VerifyCodePage.tsx`

```
Input Validation
  â”œâ”€ Phone: E.164 format
  â””â”€ Code: 6 digits (auto-formatted)

Auto-Submit: Submits when 6 digits entered (if no errors)

Resend Logic
  â”œâ”€ 45-second cooldown between resends
  â””â”€ Calls /sms-send-code edge function

Code Validation
  â”œâ”€ Sends to /verify-sms-code endpoint
  â”œâ”€ Receives session token on success
  â””â”€ Redirects to /demographics on success
```

---

## 8. SUMMARY OF ISSUES

| # | Severity | Issue | Location | Impact |
|---|----------|-------|----------|--------|
| 1 | ðŸ”´ CRITICAL | Undefined variable `temporaryPassword` | `verify-sms-code/index.ts:204` | Auto-signin fails after SMS verification |
| 2 | ðŸŸ  HIGH | No fetch timeout on Twilio API calls | `sms-send-code`, `verify-sms-code` | Requests could hang indefinitely |
| 3 | ðŸŸ  HIGH | No server-side rate limiting on verify attempts | `verify-sms-code` | Potential brute force attacks on OTP |
| 4 | ðŸŸ¡ MEDIUM | SMS delivery not confirmed before user navigates | `register/index.ts:340` | User might enter verify page before SMS arrives |
| 5 | ðŸŸ¡ MEDIUM | Auto-submit race condition on verify page | `VerifyCodePage.tsx` | Multiple submissions if code enters quickly |

---

## 9. DEPLOYMENT CHECKLIST

- [ ] Set TWILIO_ACCOUNT_SID in Supabase secrets
- [ ] Set TWILIO_AUTH_TOKEN in Supabase secrets
- [ ] Set TWILIO_VERIFY_SERVICE_SID in Supabase secrets
- [ ] Set HCAPTCHA_SECRET in Supabase secrets
- [ ] Verify Twilio credentials are correct (test with CLI)
- [ ] Test SMS sending with test phone number
- [ ] Monitor audit logs for registration failures
- [ ] Set up SMS delivery monitoring in Twilio dashboard
- [ ] Configure SMS delivery webhook (optional)
- [ ] Test verification code expiration (10 min)
- [ ] Test pending registration cleanup (24 hr)

