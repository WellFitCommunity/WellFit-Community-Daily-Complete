# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # Runs every Monday at 2:00 AM UTC

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          npm install -g audit-ci

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Initialize summary
        run: |
          echo "## 🔒 Security Scan – WellFit Community" >> $GITHUB_STEP_SUMMARY
          echo "Started at $(date -u '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
          echo "FAIL=0" >> $GITHUB_ENV

      # ============================================
      # Scan for insecure HTTP/WS protocols
      # ============================================
      - name: Scan for insecure protocols
        id: insecure-scan
        run: |
          echo "## Insecure Protocol Scan" >> $GITHUB_STEP_SUMMARY

          MATCH_HTTP=$(grep -RniE '\bhttp://(?!localhost\b|127\.0\.0\.1\b|schemas\.|0\.0\.0\.0\b)' . \
            --exclude-dir=node_modules --exclude-dir=build --exclude-dir=dist --exclude-dir=.git \
            --exclude=package-lock.json --exclude=yarn.lock 2>/dev/null || true)
          
          MATCH_WS=$(grep -RniE '\bws://(?!localhost\b|127\.0\.0\.1\b|0\.0\.0\.0\b)' . \
            --exclude-dir=node_modules --exclude-dir=build --exclude-dir=dist --exclude-dir=.git 2>/dev/null || true)

          if [ -n "$MATCH_HTTP" ] || [ -n "$MATCH_WS" ]; then
            echo "### ❌ Insecure protocol references found:" >> $GITHUB_STEP_SUMMARY
            {
              echo '```'
              [ -n "$MATCH_HTTP" ] && echo "$MATCH_HTTP"
              [ -n "$MATCH_WS" ] && echo "$MATCH_WS"
              echo '```'
            } >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ No insecure protocol references found." >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # NPM Security Audit
      # ============================================
      - name: Run npm audit
        run: |
          echo "## NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=low --json > audit-results.json || true

          if [ -s audit-results.json ]; then
            TOTAL=$(jq '.metadata.vulnerabilities.total // 0' audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            CRIT=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)

            echo "- Total vulnerabilities: $TOTAL | High: $HIGH | Critical: $CRIT" >> $GITHUB_STEP_SUMMARY

            if [ "$TOTAL" -gt 0 ]; then
              echo "### Vulnerability Details" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .vulnerabilities
                | to_entries[]
                | select(.value.severity != null)
                | "- **\(.key)**: \(.value.severity) – \(.value.title)"
              ' audit-results.json >> $GITHUB_STEP_SUMMARY || echo "_Unable to parse details_" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$HIGH" -gt 0 ] || [ "$CRIT" -gt 0 ]; then
              echo "### ❌ High/Critical vulnerabilities detected." >> $GITHUB_STEP_SUMMARY
              echo "FAIL=1" >> $GITHUB_ENV
            else
              echo "✅ No High/Critical vulnerabilities." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ npm audit produced no output." >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # CodeQL Security Analysis
      # ============================================
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: results

      - name: Check CodeQL Results
        run: |
          echo "## CodeQL Severity Check" >> $GITHUB_STEP_SUMMARY

          MIN_SEVERITY=8.9

          shopt -s nullglob
          files=(results/*.sarif results/**/*.sarif)
          
          if [ ${#files[@]} -eq 0 ]; then
            echo "ℹ️ No SARIF files found. Skipping CodeQL gate." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          total=0
          for sarif in "${files[@]}"; do
            count=$(jq --argjson min "$MIN_SEVERITY" '
              [
                .runs[].results[]? as $r
                | (
                    ($r.properties."security-severity"? // $r.rule.properties."security-severity"? // null) as $ss
                    |
                    if ($ss != null) then
                      (($ss|tostring)|tonumber) >= $min
                    else
                      ($r.level? // "") | ascii_downcase == "error"
                    end
                  )
              ] | map(select(.)) | length
            ' "$sarif")
            total=$(( total + count ))
          done

          echo "- Severity threshold: >= $MIN_SEVERITY" >> $GITHUB_STEP_SUMMARY
          echo "- High/Critical findings: $total" >> $GITHUB_STEP_SUMMARY

          if [ "$total" -gt 0 ]; then
            echo "### ❌ CodeQL detected $total high-severity issue(s)" >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ CodeQL scan passed" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # ESLint Security Plugin
      # ============================================
      - name: Run ESLint Security Scan
        run: |
          npm install --save-dev eslint eslint-plugin-security
          echo "module.exports = { extends: ['plugin:security/recommended'], plugins: ['security'], env: { node: true, es6: true }, parserOptions: { ecmaVersion: 2021, sourceType: 'module' } };" > .eslintrc.security.js
          npx eslint --config .eslintrc.security.js --ext .js,.ts,.tsx src/ supabase/ --format json > eslint-security.json || true

          echo "## ESLint Security Scan" >> $GITHUB_STEP_SUMMARY
          
          if [ -s eslint-security.json ]; then
            ISSUES=$(jq '[.[].messages] | flatten | length' eslint-security.json)
            
            if [ "$ISSUES" -gt 0 ]; then
              echo "### Findings: $ISSUES issue(s) (informational)" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .[] | select(.messages | length > 0)
                | .filePath as $file
                | .messages[] | "- **\($file)**: \(.message) (Line \(.line))"
              ' eslint-security.json >> $GITHUB_STEP_SUMMARY || echo "_Parse error_" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ No security issues found." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ ESLint produced no output." >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # Hardcoded Secrets Detection
      # ============================================
      - name: Check for hardcoded secrets
        run: |
          echo "## Secret Detection Scan" >> $GITHUB_STEP_SUMMARY

          PATTERNS=(
            "password[[:space:]]*=[[:space:]]*['\"][^'\"]{8,}"
            "api[_-]?key[[:space:]]*[:=][[:space:]]*['\"][^'\"]{20,}"
            "secret[_-]?key[[:space:]]*[:=][[:space:]]*['\"][^'\"]{20,}"
            "token[[:space:]]*[:=][[:space:]]*['\"][^'\"]{20,}"
            "-----BEGIN [A-Z ]+-----"
          )

          FOUND=false
          FILES=$(git ls-files | grep -Ev '(\.md$|\.png$|\.jpg$|\.jpeg$|\.gif$|\.svg$|\.ico$|\.pdf$|^node_modules/|^dist/|^build/)' || true)

          for f in $FILES; do
            for p in "${PATTERNS[@]}"; do
              if grep -E -q "$p" "$f" 2>/dev/null; then
                echo "- ⚠️ Potential secret in **$f**" >> $GITHUB_STEP_SUMMARY
                FOUND=true
                break
              fi
            done
          done

          if [ "$FOUND" = true ]; then
            echo "### ❌ Potential hardcoded secrets detected." >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ No hardcoded secrets detected." >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # Dependency Security Check
      # ============================================
      - name: Dependency security check
        run: |
          echo "## Dependency Security" >> $GITHUB_STEP_SUMMARY

          audit-ci --low || echo "audit-ci completed"

          npm outdated --json > outdated.json || true
          
          if [ -s outdated.json ]; then
            echo "### Outdated Packages (informational):" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries[] | "- **\(.key)**: Current \(.value.current // "n/a"), Latest \(.value.latest // "n/a")"' outdated.json >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All packages are up to date." >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # Security Headers Check
      # ============================================
      - name: Check security headers
        run: |
          echo "## Security Headers Analysis" >> $GITHUB_STEP_SUMMARY
          SCORE=0

          if grep -R "Content-Security-Policy" public/ supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then 
            echo "✅ Content-Security-Policy present" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE+1))
          fi
          
          if grep -R "X-Content-Type-Options" public/ supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then 
            echo "✅ X-Content-Type-Options present" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE+1))
          fi
          
          if grep -R "X-Frame-Options" public/ supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then 
            echo "✅ X-Frame-Options present" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE+1))
          fi
          
          if grep -R "Strict-Transport-Security" public/ supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then 
            echo "✅ HSTS present" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE+1))
          fi
          
          if grep -R "Referrer-Policy" public/ supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then 
            echo "✅ Referrer-Policy present" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE+1))
          fi
          
          if grep -R "Permissions-Policy" public/ supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then 
            echo "✅ Permissions-Policy present" >> $GITHUB_STEP_SUMMARY
            SCORE=$((SCORE+1))
          fi

          echo "### Security Headers Score: $SCORE/6" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # CORS Configuration Check
      # ============================================
      - name: Check CORS configuration
        run: |
          echo "## CORS Security Check" >> $GITHUB_STEP_SUMMARY

          if grep -R "Access-Control-Allow-Origin.*\*" supabase/ src/ 2>/dev/null; then
            echo "### ❌ Wildcard CORS detected - this is a security risk!" >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ No wildcard CORS found" >> $GITHUB_STEP_SUMMARY
          fi

          if grep -R "ALLOWED_ORIGINS\|allowedOrigins" supabase/ src/ 2>/dev/null | head -1 >> /dev/null; then
            echo "✅ Origin allowlist implementation found" >> $GITHUB_STEP_SUMMARY
          fi

      # ============================================
      # Upload Results as Artifacts
      # ============================================
      - name: Prepare result files
        if: always()
        run: |
          touch audit-results.json eslint-security.json outdated.json

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            audit-results.json
            eslint-security.json
            outdated.json
            results/*.sarif
          if-no-files-found: ignore
          retention-days: 30

      # ============================================
      # Final Summary
      # ============================================
      - name: Finalize summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "Completed at $(date -u '+%Y-%m-%d %H:%M:%S') UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next scheduled scan:** Monday at 02:00 UTC" >> $GITHUB_STEP_SUMMARY

      - name: Fail job if critical issues found
        if: always()
        run: |
          if [ "${FAIL:-0}" = "1" ]; then
            echo "🔴 Critical security issues detected. Please review the summary above."
            exit 1
          else
            echo "🟢 No critical security issues found. All gates passed!"
          fi