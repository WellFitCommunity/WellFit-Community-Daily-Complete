# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1' # Mondays 02:00 UTC

jobs:
  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install tooling (jq + audit-ci)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          npm i -g audit-ci

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi

      - name: Init summary + fail flag
        run: |
          echo "## 🔒 Security Scan – WellFit Community" >> $GITHUB_STEP_SUMMARY
          echo "Started at $(date -u) UTC" >> $GITHUB_STEP_SUMMARY
          echo "FAIL=0" >> $GITHUB_ENV

      # ---------------------------
      # Insecure protocol scanner
      # ---------------------------
      - name: Scan for insecure http:// and ws://
        id: insecure-scan
        run: |
          echo "## Insecure Request Scan" >> $GITHUB_STEP_SUMMARY

          # Ignore common benign cases: localhost/127.0.0.1, schema refs, comments in lockfiles, etc.
          MATCH_HTTP=$(grep -RniE '\bhttp://(?!localhost\b|127\.0\.0\.1\b|schemas\.|0\.0\.0\.0\b)' . \
            --exclude-dir=node_modules --exclude-dir=build --exclude-dir=dist --exclude-dir=.git \
            --exclude=package-lock.json --exclude=yarn.lock 2>/dev/null || true)
          MATCH_WS=$(grep -RniE '\bws://(?!localhost\b|127\.0\.0\.1\b|0\.0\.0\.0\b)' . \
            --exclude-dir=node_modules --exclude-dir=build --exclude-dir=dist --exclude-dir=.git 2>/dev/null || true)

          if [ -n "$MATCH_HTTP$MATCH_WS" ]; then
            echo "### ❌ Insecure references found:" >> $GITHUB_STEP_SUMMARY
            {
              echo '```'
              echo "$MATCH_HTTP"
              echo "$MATCH_WS"
              echo '```'
            } >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ No insecure protocol references found." >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------
      # NPM audit (JSON to summary)
      # ---------------------------
      - name: Run npm audit
        run: |
          echo "## NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=low --json > audit-results.json || true

          if [ -s audit-results.json ]; then
            TOTAL=$(jq '.metadata.vulnerabilities.total // 0' audit-results.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            CRIT=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)

            echo "- Total: $TOTAL | High: $HIGH | Critical: $CRIT" >> $GITHUB_STEP_SUMMARY

            if [ "$TOTAL" -gt 0 ]; then
              echo "### Vulnerabilities Summary" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .vulnerabilities
                | to_entries[]
                | select(.value.severity != null)
                | "- **\(.key)**: \(.value.severity) – \(.value.title)"
              ' audit-results.json >> $GITHUB_STEP_SUMMARY || echo "Parse error" >> $GITHUB_STEP_SUMMARY
            fi

            # Gate ONLY on High/Critical
            if [ "$HIGH" -gt 0 ] || [ "$CRIT" -gt 0 ]; then
              echo "### ❌ High/Critical vulnerabilities present." >> $GITHUB_STEP_SUMMARY
              echo "FAIL=1" >> $GITHUB_ENV
            else
              echo "✅ No High/Critical vulnerabilities." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ npm audit produced no output." >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------
      # CodeQL
      # ---------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          # queries: +security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis (emit SARIF locally too)
        uses: github/codeql-action/analyze@v3
        with:
          output: results

      # ---- Deterministic gate on CodeQL SARIF (numeric severity) ----
      - name: Gate on CodeQL SARIF severities
        run: |
          echo "## CodeQL Severity Gate" >> $GITHUB_STEP_SUMMARY

          # Numeric threshold for High/Critical (CVSS-like)
          MIN_SEVERITY=8.9  # change to 7.0 to include 'High', or 9.0 for Critical-only

          shopt -s nullglob
          files=(results/*.sarif results/**/*.sarif)
          if [ ${#files[@]} -eq 0 ]; then
            echo "ℹ️ No SARIF files found in results/. Skipping CodeQL gate." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          total=0
          for sarif in "${files[@]}"; do
            count=$(jq --argjson min "$MIN_SEVERITY" '
              [
                .runs[].results[]? as $r
                | (
                    # Prefer CodeQL numeric security-severity; fall back to rule property; else map "level"
                    (
                      ($r.properties."security-severity"? // $r.rule.properties."security-severity"? // null)
                    ) as $ss
                    |
                    if ($ss != null) then
                      ( ($ss|tostring)|tonumber ) >= $min
                    else
                      # fallback: treat "level:error" as High/Critical
                      ($r.level? // "") | ascii_downcase == "error"
                    end
                  )
              ] | map(select(.)) | length
            ' "$sarif")
            echo "File: $sarif -> High/Critical count: $count"
            total=$(( total + count ))
          done

          {
            echo "- Numeric threshold: >= $MIN_SEVERITY"
            echo "- Total matching findings: $total"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$total" -gt 0 ]; then
            echo "### ❌ CodeQL findings exceed threshold ($total)" >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ CodeQL gate passed" >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------
      # ESLint Security
      # ---------------------------
      - name: Run ESLint Security Plugin
        run: |
          npm i -D eslint eslint-plugin-security
          echo "module.exports = { extends: ['plugin:security/recommended'], plugins: ['security'], env: { node: true, es6: true }, parserOptions: { ecmaVersion: 2021, sourceType: 'module' } };" > .eslintrc.security.js
          npx eslint --config .eslintrc.security.js --ext .js,.ts,.tsx src/ supabase/ --format json > eslint-security.json || true

          echo "## ESLint Security Scan" >> $GITHUB_STEP_SUMMARY
          if [ -s eslint-security.json ]; then
            ISSUES=$(jq '[.[].messages] | flatten | length' eslint-security.json)
            if [ "$ISSUES" -gt 0 ]; then
              echo "### Findings: $ISSUES (informational)" >> $GITHUB_STEP_SUMMARY
              jq -r '
                .[] | select(.messages | length > 0)
                | .filePath as $file
                | .messages[] | "- **\($file)**: \(.message) (Line \(.line))"
              ' eslint-security.json >> $GITHUB_STEP_SUMMARY || echo "Parse error" >> $GITHUB_STEP_SUMMARY

              # If you want ESLint to be a gate, uncomment the next two lines:
              # echo "### ❌ ESLint Security gate tripped" >> $GITHUB_STEP_SUMMARY
              # echo "FAIL=1" >> $GITHUB_ENV
            else
              echo "✅ No security issues found!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ ESLint produced no output." >> $GITHUB_STEP_SUMMARY

      # ---------------------------
      # Secret scanning (filenames only)
      # ---------------------------
      - name: Check for secrets in code
        run: |
          echo "## Secret Detection" >> $GITHUB_STEP_SUMMARY

          PATTERNS=(
            "password[[:space:]]*=[[:space:]]*['\"][^'\"]{8,}"
            "api[_-]?key[[:space:]]*[:=][[:space:]]*['\"][^'\"]{20,}"
            "secret[_-]?key[[:space:]]*[:=][[:space:]]*['\"][^'\"]{20,}"
            "token[[:space:]]*[:=][[:space:]]*['\"][^'\"]{20,}"
            "-----BEGIN [A-Z ]+-----"
          )

          FOUND=false
          FILES=$(git ls-files | grep -Ev '(\.md$|\.png$|\.jpg$|\.jpeg$|\.gif$|\.svg$|\.ico$|\.pdf$|^node_modules/|^dist/|^build/)' || true)

          for f in $FILES; do
            for p in "${PATTERNS[@]}"; do
              if grep -E -q "$p" "$f"; then
                echo "- Potential secret in **$f**" >> $GITHUB_STEP_SUMMARY
                FOUND=true
                break
              fi
            done
          done

          if [ "$FOUND" = true ]; then
            echo "### ❌ Potential secrets detected." >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ No hardcoded secrets detected!" >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------
      # Dependency check (audit-ci + outdated)
      # ---------------------------
      - name: Dependency security & freshness
        run: |
          echo "## Dependency Security Check" >> $GITHUB_STEP_SUMMARY

          audit-ci --low || echo "audit-ci finished (non-blocking)"

          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "### Outdated Packages (informational):" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries[] | "- **\(.key)**: Current \(.value.current // "n/a"), Latest \(.value.latest // "n/a")"' outdated.json >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ No outdated packages reported." >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------
      # Headers & CORS checks
      # ---------------------------
      - name: Security Headers Check
        run: |
          echo "## Security Headers Analysis" >> $GITHUB_STEP_SUMMARY
          SCORE=0

          if grep -R "Content-Security-Policy" public/ supabase/ src/ 2>/dev/null; then echo "✅ Content-Security-Policy present" >> $GITHUB_STEP_SUMMARY; SCORE=$((SCORE+1)); fi
          if grep -R "X-Content-Type-Options" public/ supabase/ src/ 2>/dev/null; then echo "✅ X-Content-Type-Options present" >> $GITHUB_STEP_SUMMARY; SCORE=$((SCORE+1)); fi
          if grep -R "X-Frame-Options" public/ supabase/ src/ 2>/dev/null; then echo "✅ X-Frame-Options present" >> $GITHUB_STEP_SUMMARY; SCORE=$((SCORE+1)); fi
          if grep -R "Strict-Transport-Security" public/ supabase/ src/ 2>/dev/null; then echo "✅ HSTS present" >> $GITHUB_STEP_SUMMARY; SCORE=$((SCORE+1)); fi
          if grep -R "Referrer-Policy" public/ supabase/ src/ 2>/dev/null; then echo "✅ Referrer-Policy present" >> $GITHUB_STEP_SUMMARY; SCORE=$((SCORE+1)); fi
          if grep -R "Permissions-Policy" public/ supabase/ src/ 2>/dev/null; then echo "✅ Permissions-Policy present" >> $GITHUB_STEP_SUMMARY; SCORE=$((SCORE+1)); fi

          echo "### Headers Score: $SCORE/6" >> $GITHUB_STEP_SUMMARY

      - name: CORS Configuration Check
        run: |
          echo "## CORS Security Check" >> $GITHUB_STEP_SUMMARY

          if grep -R "Access-Control-Allow-Origin.*\*" supabase/ src/ 2>/dev/null; then
            echo "❌ Wildcard CORS detected - security risk!" >> $GITHUB_STEP_SUMMARY
            echo "FAIL=1" >> $GITHUB_ENV
          else
            echo "✅ No wildcard CORS found" >> $GITHUB_STEP_SUMMARY
          fi

          if grep -R "ALLOWED_ORIGINS\|allowedOrigins" supabase/ src/ 2>/dev/null; then
            echo "✅ Origin allowlist implementation found" >> $GITHUB_STEP_SUMMARY
          fi

      # ---------------------------
      # Upload artifacts
      # ---------------------------
      - name: Ensure result files exist
        if: always()
        run: |
          touch audit-results.json eslint-security.json outdated.json

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            audit-results.json
            eslint-security.json
            outdated.json
            results/*.sarif
          if-no-files-found: ignore
          retention-days: 30

      # ---------------------------
      # Finalize
      # ---------------------------
      - name: Security Scan Summary
        if: always()
        run: |
          echo "## ✅ Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "Completed at $(date -u) UTC" >> $GITHUB_STEP_SUMMARY
          echo "**Next scan:** Next Monday or on your next push" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical issues were found
        if: always()
        run: |
          if [ "${FAIL:-0}" = "1" ]; then
            echo "🔴 Critical issues detected (see summary). Failing job."
            exit 1
          else
            echo "🟢 No critical gates tripped."
          fi
